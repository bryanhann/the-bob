# check if stdout is a terminal...
if test -t 1; then

    # see if it supports colors...
    ncolors=$(tput colors)

    if test -n "$ncolors" && test $ncolors -ge 8; then
        bold="$(tput bold)"
        underline="$(tput smul)"
        standout="$(tput smso)"
        normal="$(tput sgr0)"
        black="$(tput setaf 0)"
        red="$(tput setaf 1)"
        green="$(tput setaf 2)"
        yellow="$(tput setaf 3)"
        blue="$(tput setaf 4)"
        magenta="$(tput setaf 5)"
        cyan="$(tput setaf 6)"
        white="$(tput setaf 7)"
    fi
fi
if [ -t 1 ]; then 
	export BOLD=$( tput bold )
	export NORMAL=$( tput sgr0 )
else
	unset BOLD
	unset NORMAL
fi
function ut_desc { export ut_USER_DESC=$1 ; }
function ut_expr { export ut_USER_EXPR=$* ; }
function ut_err  { export ut_USER_ERR=$1  ; }
function ut_out  { export ut_USER_OUT=$1  ; }
function ut_show { set | grep ^ut_[A-Z]   ; }

function ut_new {
	unset ut_USER_DESC
	unset ut_USER_EXPR
	unset ut_USER_ERR
	unset ut_USER_OUT
	unset ut_TEST_ERR
	unset ut_TEST_OUT
}

function ut {
	ut_new
	while [ ! "$1" == "" ]; do
		if [ "$1" == "-e" ]; then ut_err "$2" ; shift 2 ; continue ; fi
		if [ "$1" == "-o" ]; then ut_out "$2" ; shift 2 ; continue ; fi
		if [ "$1" == "-d" ]; then ut_desc "$2"; shift 2 ; continue ; fi
		if [ "$1" == "-t" ]; then ut_expr "$2"; shift 2 ; continue ; fi
		if [    . == .    ]; then shift ; continue ; fi
	done
	ut_exec
}

function __ok_out {
	[ ! -v ut_USER_OUT ] && return 0
        [ "$ut_USER_OUT" == "$ut_TEST_OUT" ] && return 0
	return 1
}

function __ok_err {
	[ ! -v ut_USER_ERR ] && return 0
      	[ "$ut_USER_ERR" == "$ut_TEST_ERR" ] && return 0
	return 1
}
function __fail {
	! __ok_out && return 0
	! __ok_err && return 0
	[ ! -v ut_USER_ERR ] && [ ! "$ut_TEST_ERR" == "0" ] && return 0	
	return 1
}

function ut_exec { 

	[ -v ut_USER_ERR ]  || ut_err 0
	[ -v ut_USER_DESC ] || ut_desc "Anonymous Test"
	echo
	if [ -t 1 ]; then
		#we are at a tty
		echo -n [....] Runtest: $ut_USER_DESC 
		echo -n -e "\b\b\b\b\b\b\b\b\b\b\b\b\b"
		echo -n -e "\b\b\b\b\b\b\b\b\b\b\b\b\b"
		echo -n -e "\b\b\b\b\b\b\b\b\b\b\b\b\b"
		echo -n -e "\b\b\b\b\b\b\b\b\b\b\b\b\b"
		echo -n -e "\b\b\b\b\b\b\b\b\b\b\b\b\b"
		echo -n -e "\b\b\b\b\b\b\b\b\b\b\b\b\b"
		echo -n -e "\b\b\b\b\b\b\b\b\b\b\b\b\b"
		echo -n -e "\b\b\b\b\b\b\b\b\b\b\b\b\b"
		echo -n -e "\b\b\b\b\b\b\b\b\b\b\b\b\b"
	else
		echo Runtest: $ut_USER_DESC 
	fi	
	ut_TEST_OUT=$( eval $ut_USER_EXPR )
	ut_TEST_ERR=$?

	__fail && echo "[${BOLD}${red}FAIL${NORMAL}]" || echo "[PASS]"

	[ "" == "" ]       && echo "        \$( $ut_USER_EXPR )"
	[ -v ut_USER_ERR ] && echo "        -e $ut_USER_ERR"
	[ -v ut_USER_OUT ] && echo "        -o $ut_USER_OUT"
	
	__ok_out          || echo "        unexpected out: [$ut_TEST_OUT]"
	__ok_err          || echo "        unexpected err: [$ut_TEST_ERR]"
}

